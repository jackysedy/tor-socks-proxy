
node {
    stage("Git"){
        git credentialsId: 'cced35f3-1bac-42ef-81d3-960072464a3b', url: 'https://github.com/jackysedy/tor-socks-proxy'
    }
    stage('chooseDockerTags') {
        if ( currentBuild.rawBuild.getCauses()[0].toString().contains('UserIdCause') ){

            sh """
                sed -i 's/tor-socks-proxy:latest/tor-socks-proxy:${Tags}/g' docker-compose.yml
            """    
            def values = Tags.split('_')
            Port = values[1]
            sh"""
                sed -i 's/XXXX/${Port}/g' docker-compose.yml
            """
        }
        else{
            println "Pulling Tag: $Tag"
            sh """
                sed -i 's/tor-socks-proxy:latest/tor-socks-proxy:${Tag}_${Port}/g' docker-compose.yml
                sed -i 's/XXXX/$Port/g' docker-compose.yml
                
            """
        }
        sh """
            cd test
            docker build --no-cache -t test .
            cd ..
        """
        docker.withRegistry('https://registry.hub.docker.com/v1/repositories/jackysedi/tor-socks-proxy') {
            sh """
                docker-compose up --abort-on-container-exit 
            """
        }
    }
}
